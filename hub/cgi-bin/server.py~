#!/usr/bin/python

# general HTTP interface to our LDAP index server

import ldap, ldap.filter
import hashlib, binascii, os, re, random, os.path, sys, smtplib, email, email.utils, time
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication

__location__ = os.path.realpath(
    os.path.join(os.getcwd(), os.path.dirname(__file__)))

SWEARWORDS = ['SHIT', 'FUCK', 'CUNT', 'TWAT']

DEFAULT_TO= "ian@haywood.id.au"
DEFAULT_FROM="ldap@athen.net.au"
DEFAULT_SERVER="haywood.id.au"

from flask import Flask
from flask import request
app = Flask(__name__)

base_dn = 'dc=athen,dc=net,dc=au'
org_fields = ['o','l','st','businessCategory','street','postalCode','telephoneNumber','facsimileTelephoneNumber','userPassword','mail','status']


def send_mail(subject, text, dvi=None):
    msg = MIMEMultipart(
        From=DEFAULT_FROM,
        To=DEFAULT_TO,
        Date=email.utils.formatdate(localtime=True),
        Subject=subject
    )
    msg.attach(MIMEText(text))
    if dvi:
        with open(dvi, "rb") as fil:
            msg.attach(MIMEApplication(
                fil.read(),
                "x-dvi",
                Content_Disposition='attachment; filename="%s"' % basename(dvi),
                Name=basename(dvi)
            ))
    smtp = smtplib.SMTP(DEFAULT_SERVER)
    smtp.starttls()
    smtp.sendmail(send_from, [DEFAULT_TO], msg.as_string())
    smtp.close()

def ldap_time():
    return time.strftime("%Y%m%d%H%M%SZ",time.gmtime())

def get_ldap():
    """Opens a new LDAP connection if there is none yet for the
    current application context.
    """
    if not hasattr(g, 'ldap'):
        g.ldap = ldap.initialize('ldap://localhost/')
        g.ldap.simple_bind_s('cn=Admin,dc=athen,dc=net,dc=au','password')
    return g.ldap


def ldap_query(base_dn,query,fields,args=None,scope=ldap.SCOPE_SUBTREE,dn_args=None):
    if not dn_args is None:
        base_dn = ldap.filter.filter_format(base_dn,dn_args)
    if not args is None:
        query = ldap.filter.filter_format(query,args)
    res = g.ldap.search-s(base_dn,scope,query,fields)
    return [fold_dn(i) for i in res]
    
def check_swear(s):
    for i in SWEARWORDS:
        if i in s:
            return True
    return False

def make_salt():
    return binascii.hexlify(os.urandom(16))

def make_hash(password,stub):
    fields = stub.split("$")
    algo = int(fields[1])
    algo_names = ['invalid','sha256','sha512']
    salt = fields[2]
    reps = int(fields[3])*10000
    dk = hashlib.pbkdf2_hmac(algo_names[algo],bytes(password),binascii.unhexlify(salt),reps)
    h = binascii.hexlify(dk)
    return "$"+str(algo)+"$"+str(reps)+"$"+salt+"$"+h+"$"

def create_new_hash(password):
    return make_hash(password,"$1$20$"+make_salt())

def clean_string(s):
    """Remove LDAP-sensitive chars from a string"""
    translation_table = dict.fromkeys(map(ord, '!@#(){}%^&*|=+\n\r\t";:<>,'), None)
    return s.translate(translation_table)


def fold_dn(i):
    dn, vals = i
    vals = {k: v[0] for k, v in vals}
    vals['dn'] = dn
    return vals


@app.route('/')
def index():
    return render_template('index.html')


@app.route('/org/search')
def searchorg():
    get_ldap()
    res = g.ldap.search_s( base_dn, ldap.SCOPE_SUBTREE, ldap.filter.filter_format("(&(o=%s*)(objectclass=athenOrganization))",[request.args.get('key', '')]),['o','l','st','businessCategory'])
    res = [fold_dn(i) for i in res] # fold the DNs in the dict to make it a bit easier to work with
    return render_template('searchorg.html',result=res)

@app.route('/org/show')
def showorg():
    get_ldap()
    the_dn = ldap.filter.filter_format("o=%s,",[request.args['o']])+base_dn
    org = ldap_query(the_dn,"(objectclass=athenOrganization)",scope=ldap.SCOPE_BASE)
    users = ldap_query(the_dn,"(objectclass=athenPerson)")
    return render_template('showorg.html',org=org,users=users)

@app.route('/org/new'):
def neworg():
    vals = {i: "" for i in org_fields}
    vals['error'] = ""
    vals['error_field'] = ""
    vals['mode'] = 'new'
    return render_template('editorg.html',**vals)

def load_from_form(fieldslist):
    vals = {}
    for f in fieldslist:
        val = clean_string(request.form[f])
        if val != "":
            vals[f] = val
    return vals

def org_fields_validate(vals):
    vals['error'] = None
    if "o" in vals:
        if len(vals["o"]) < 4:
            vals['error_field'] = "o"
            vals['error'] = "Organisation name is too short"
    if "l" in vals:
        if len(vals["l"]) < 3:
            vals['error_field'] = "l"
            vals['error'] = "Suburb name is too short"
    if "street" in vals:
        if len(vals["street"]) < 3:
            vals['error_field'] = "street"
            vals['error'] = "Street name is too short"
    if "postalCode" in vals:
        m = re.match("^[0-9]{4}$",vals['postalCode'])
        if not m:
            vals['error_field'] = 'postalCode'
            vals['error'] = "Postcode must be four digits"
    if "telephoneNumber" in vals:
        vals['telephoneNumber'] = re.sub("[^0-9]", "", vals['telephoneNumber'])
        m = re.match("^[0-9]{7,10}$",vals['telphoneNumber'])
        if not m:
            vals['error_field'] = 'telphoneNumber'
            vals['error'] = "telephone number must be 7 to 10 digits"
    if "facsimileTelephoneNumber" in vals:
        vals['facsimileTelephoneNumber'] = re.sub("[^0-9]", "", vals['facsimileTelephoneNumber'])
        m = re.match("^[0-9]{7,10}$",vals['facsimileTelphoneNumber'])
        if not m:
            vals['error_field'] = 'facsimileTelphoneNumber'
            vals['error'] = "fax number must be 7 to 10 digits"
    return vals

@app.route('/org/save')
def neworg():
    vals = load_from_form(org_fields[:-1})
    vals['mode'] = 'new'
    for f in ['o','l','street','telephoneNumber','postalCode','userPassword','userPassword_repeat']:
        if not f in vals:
            vals['error_field'] = f
            if f == 'o': f = "organisation name"
            if f == 'l': f = "suburb"
            vals["error"] = f+" is required"
            return render_template('neworg.html',**vals)
    if vals['userPassword'] != vals['userPassword_repeat']:
        vals['error_field'] = 'userPassword_repeat'
        vals['error'] = "passwords do not match"
        return render_template('editorg.html',**vals)
    if len(vals['userPassword']) < 6:
        vals["error"] = "password must be at least 6 characters"
        vals["error_field"] = "userPassword"
        return render_template('editorg.html',**vals)
    vals = org_fields_validate(vals)
    if vals['error'] is None:
        vals['userPassword'] = create_new_hash(vals['userPassword'])
        nonce = SWEARWORDS[0]
        alphas = [chr(i) for i in range(ord('A'),ord('Z')+1)]
        while check_swear(nonce):
            nonce = ''.join(random.choice(alphas) for dum in range(1,8))
        vals['nonce'] = nonce
        with open(__location__+'/invite.tex','r') as f:
            latex = f.read()
        latex = latex.format(**vals)
        fd, tmpf = tempfile.mkstemp(".tex")
        os.write(fd, latex)
        os.close(fd)
        os.chdir(os.path.dirname(tmpf))
        os.system("latex {}".format(tmpf))
        with open(tempf[:-3]+'dvi','r') as f:
            dvi = f.read()
        send_mail("New Organisation","\n".join("{}: {}".format(k, v) for k, v in vals.items()),dvi)
        get_ldap()
        new_dn = "o={},{}".format(vals['o'],base_dn)
        # check if exists
        res = g.ldap.search_s(new_dn,ldap.SCOPE_BASE,"{objectclass=athenOrganization)",["o"])
        if len(res) > 0:
            vals['error'] = 'Organisation of that name already exists'
            val['error_field'] = "o"
            del vals["nonce"]
            return render_template('editorg.html',**vals)
        vals['status'] = "P" # provisional
        vals['timeCreated'] = vals['timeLastUsed'] = ldap_time()
        del vals['mode']
        del vals['error']
        modlist = [(k,[v]) for k, v in vals.items()]
        modlist.append(('objectclass',['organization','athenOrganization']))
        g.ldap.add_s(new_dn,modlist)
        flash('New organisation saved successfully')
        return redirect(url_for('index'))
    else:
        return render_template('neworg.html',**vals)

@app.route('/org/edit'):
def editorg():
    get_ldap()
    the_dn = ldap.filter.filter_format("o=%s,",[request.args['o']])+base_dn
    res = g.ldap.search_s(the_dn,ldap.SCOPE_BASE,"{objectclass=athenOrganization)",org_fields)
    if len(res) == 0: # shouldn't ever happen really
        flash('No such organisation')
        return redirect(url_for('index'))
    vals = fold_dn(res[0])
    vals['error'] = ""
    vals['error_field'] = ""
    vals['mode'] = 'edit'
    return render_template('editorg.html',**vals)

@app.route('/org/update')
def updateorg():
    vals = load_from_form(org_fields[:-1])
    vals['mode'] = 'edit'
    if "status_closed" in vals and vals["status_closed"] = "yes":
        del vals['status_closed']
        vals['status'] = 'X'
    vals = org_fields_validate(vals)
    if not vals['error'] is None:
        return render_template('neworg.html',**vals)
    get_ldap()
    the_dn = ldap.filter.filter_format("o=%s,",[request.args['o']])+base_dn
    res = g.ldap.search_s(the_dn,ldap.SCOPE_BASE,"{objectclass=athenOrganization)", ["userPassword"])
    old_password = res[0][1]["userPassword"][0]
    if old_password != make_hash(vals['userPassword'],old_password):
        vals['error'] = 'Wrong password'
        vals['error_field'] = 'userPassword'
        return render_template('neworg.html',**vals)
    del vals['mode']
    del vals['error']
    modlist = [(ldap.MOD_REPLACE,k,[v]) for k, v in vals.items()]
    g.ldap.modify_s(the_dn,modlist)
    flash("Organisation record modified")
    return redirect(url_for("index"))


user_fields = ['givenName','sn','medicalSpecialty','providerNumber']

@app.route('/user/new')
def newuser():
    return render_template("newuser.html",mode='new',o=request.args["o"],error=None,givenName='',sn='',medicalSpecialty='',providerNumber='')

@app.route('/user/edit')
def edituser():
    get_ldap()
    the_dn = ldap.filter.filter_format("cn=%s,o=%s,",[request.args['cn'],request.args['o']])+base_dn
    res = ldap_query(the_dn,"(objectclass=athenPerson)",user_fields,scope=ldap.SCOPE_BASE)
    vals = res[0]
    vals['error'] = None
    vals['mode'] = 'edit'
    return render_template('edituser.html',**vals)

@app.route('/user/save')
def newuser():
    get_ldap()
    cn = request.form["givenName"]+" "+request.form['sn']
    vals = load_from_form(user_fields)
    vals['cn'] = cn
    the_dn = ldap.filter.filter_format("cn=%s,o=%s,",[cn,request.form['o']])+base_dn
    org_dn = ldap.filter.filter_format("o=%s,",[request.form['o']])+base_dn
    res = ldap_query(the_dn,"(objectclass=athenPerson)",["cn"],scope=ldap.SCOPE_BASE)
    if len(res) > 0:
        vals['error'] = 'user of same name exists'
        vals['error_field'] = 'givenName'
        return render_template('edituser.html',**vals)
    res = ldap_query(org_dn,"(objectclass=athenOrganisation",["mail"],scope=ldap.SCOPE_BASE)
    vals['mail'] = res[0]['mail']
    validate_user(vals)
    if not vals['error']
if __name__ == '__main__':
    app.run(debug=True)



